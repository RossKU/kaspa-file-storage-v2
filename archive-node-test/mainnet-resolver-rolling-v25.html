<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa Discovery Worker V25 - Proper Implementation</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h1 { color: #4CAF50; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #45a049; }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            max-height: 600px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        .archive { color: #9C27B0; font-weight: bold; }
        .debug { color: #9E9E9E; font-style: italic; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>Kaspa Discovery Worker V25</h1>
    
    <div class="container">
        <h2>Controls</h2>
        <button id="initBtn">Initialize</button>
        <button id="startBtn" disabled>Start Discovery</button>
        <button id="stopBtn" disabled>Stop Discovery</button>
        <button id="terminateBtn" disabled>Terminate Worker</button>
    </div>
    
    <div class="container">
        <h2>Stats</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statProgress">0</div>
                <div class="stat-label">Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statTested">0</div>
                <div class="stat-label">Tested</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statArchive">0</div>
                <div class="stat-label">Archive</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statErrors">0</div>
                <div class="stat-label">Errors</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>Archive Nodes Found</h2>
        <div id="archiveNodes">None found yet</div>
    </div>
    
    <div class="container">
        <h2>Logs</h2>
        <div id="log" class="log"></div>
    </div>
    
    <script src="./kaspa-discovery.js?v=25"></script>
    <script>
        // Create discovery instance
        const discovery = new KaspaDiscovery({
            workerPath: './kaspa-discovery.worker.js?v=25',
            kaspaScriptUrl: './kaspa-core.js',
            testInterval: 2000,
            maxNodes: 100
        });
        
        // UI elements
        const initBtn = document.getElementById('initBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const terminateBtn = document.getElementById('terminateBtn');
        const logDiv = document.getElementById('log');
        
        // Log function
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = level;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Setup event listeners
        discovery.addEventListener('initialized', (e) => {
            if (e.detail.success) {
                log('âœ“ Worker initialized successfully', 'success');
                initBtn.disabled = true;
                startBtn.disabled = false;
                terminateBtn.disabled = false;
            } else {
                log(`âœ— Initialization failed: ${e.detail.error}`, 'error');
            }
        });
        
        discovery.addEventListener('started', () => {
            log('âœ“ Discovery started', 'success');
            startBtn.disabled = true;
            stopBtn.disabled = false;
        });
        
        discovery.addEventListener('stopped', () => {
            log('Discovery stopped', 'info');
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });
        
        discovery.addEventListener('terminated', () => {
            log('Worker terminated', 'warning');
            initBtn.disabled = false;
            startBtn.disabled = true;
            stopBtn.disabled = true;
            terminateBtn.disabled = true;
        });
        
        discovery.addEventListener('log', (e) => {
            log(e.detail.message, e.detail.level);
        });
        
        discovery.addEventListener('error', (e) => {
            log(`Error: ${e.detail.message}`, 'error');
        });
        
        discovery.addEventListener('archiveFound', (e) => {
            log(`ðŸŽ‰ Archive node found: ${e.detail.url} (${e.detail.blockCount.toLocaleString()} blocks)`, 'archive');
        });
        
        discovery.addEventListener('stateUpdate', (e) => {
            const state = e.detail;
            
            // Update stats
            document.getElementById('statProgress').textContent = state.nodeIndex || 0;
            document.getElementById('statTested').textContent = state.stats.tested;
            document.getElementById('statArchive').textContent = state.stats.archive;
            document.getElementById('statErrors').textContent = state.stats.errors;
            
            // Update archive nodes
            if (state.archiveNodes.length > 0) {
                document.getElementById('archiveNodes').innerHTML = state.archiveNodes.map(node => 
                    `<div style="margin: 5px 0; padding: 5px; background: #333; border-radius: 4px;">
                        <strong>${node.version}</strong> - ${node.blockCount.toLocaleString()} blocks
                    </div>`
                ).join('');
            }
        });
        
        // Button handlers
        initBtn.addEventListener('click', async () => {
            try {
                log('Initializing Worker...', 'info');
                await discovery.init();
            } catch (error) {
                log(`Init error: ${error.message}`, 'error');
            }
        });
        
        startBtn.addEventListener('click', () => {
            discovery.start();
        });
        
        stopBtn.addEventListener('click', () => {
            discovery.stop();
        });
        
        terminateBtn.addEventListener('click', () => {
            discovery.terminate();
        });
        
        // Make discovery available globally for debugging
        window.discovery = discovery;
        
        log('Kaspa Discovery Worker v25 ready', 'info');
        log('Click Initialize to begin', 'info');
    </script>
</body>
</html>
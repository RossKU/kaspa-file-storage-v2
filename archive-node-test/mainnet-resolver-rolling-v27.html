<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa Discovery Worker V27 - Connect Debug</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h1 { color: #4CAF50; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #45a049; }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            max-height: 800px;
            overflow-y: auto;
            font-size: 11px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; font-weight: bold; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        .archive { color: #9C27B0; font-weight: bold; }
        .debug { color: #9E9E9E; font-style: italic; }
    </style>
</head>
<body>
    <h1>Kaspa Discovery Worker V27 - Connect Debug</h1>
    
    <div class="container">
        <h2>Controls</h2>
        <button id="initBtn">Initialize</button>
        <button id="startBtn" disabled>Start Discovery</button>
        <button id="stopBtn" disabled>Stop Discovery</button>
        <button id="terminateBtn" disabled>Terminate Worker</button>
    </div>
    
    <div class="container">
        <h2>Stats</h2>
        <div id="stats">Not initialized</div>
    </div>
    
    <div class="container">
        <h2>Logs (Enhanced Debug)</h2>
        <div id="log" class="log"></div>
    </div>
    
    <script src="./kaspa-discovery.js?v=27"></script>
    <script>
        // Create discovery instance
        const discovery = new KaspaDiscovery({
            workerPath: './kaspa-discovery.worker.js?v=27',
            kaspaScriptUrl: './kaspa-core.js',
            testInterval: 2000,
            maxNodes: 3  // Very limited for debugging
        });
        
        // UI elements
        const initBtn = document.getElementById('initBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const terminateBtn = document.getElementById('terminateBtn');
        const statsDiv = document.getElementById('stats');
        const logDiv = document.getElementById('log');
        
        // Log function
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = level;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${level}] ${message}`);
        }
        
        // Setup event listeners
        discovery.addEventListener('initialized', (e) => {
            if (e.detail.success) {
                log('âœ“ Worker initialized successfully', 'success');
                initBtn.disabled = true;
                startBtn.disabled = false;
                terminateBtn.disabled = false;
            } else {
                log(`âœ— Initialization failed: ${e.detail.error}`, 'error');
            }
        });
        
        discovery.addEventListener('started', () => {
            log('âœ“ Discovery started', 'success');
            startBtn.disabled = true;
            stopBtn.disabled = false;
        });
        
        discovery.addEventListener('stopped', () => {
            log('Discovery stopped', 'info');
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });
        
        discovery.addEventListener('terminated', () => {
            log('Worker terminated', 'warning');
            initBtn.disabled = false;
            startBtn.disabled = true;
            stopBtn.disabled = true;
            terminateBtn.disabled = true;
        });
        
        discovery.addEventListener('log', (e) => {
            log(e.detail.message, e.detail.level);
        });
        
        discovery.addEventListener('error', (e) => {
            log(`ERROR: ${e.detail.message}`, 'error');
            if (e.detail.error) {
                console.error('Full error:', e.detail.error);
            }
        });
        
        discovery.addEventListener('archiveFound', (e) => {
            log(`ðŸŽ‰ Archive node found: ${e.detail.url} (${e.detail.blockCount} blocks)`, 'archive');
        });
        
        discovery.addEventListener('stateUpdate', (e) => {
            const state = e.detail;
            statsDiv.innerHTML = `
                <strong>Progress:</strong> ${state.nodeIndex || 0} nodes<br>
                <strong>Tested:</strong> ${state.stats.tested}<br>
                <strong>Archive:</strong> ${state.stats.archive}<br>
                <strong>Errors:</strong> ${state.stats.errors}
            `;
        });
        
        // Button handlers
        initBtn.addEventListener('click', async () => {
            try {
                log('Initializing Worker...', 'info');
                await discovery.init();
            } catch (error) {
                log(`Init error: ${error.message}`, 'error');
                console.error('Init error details:', error);
            }
        });
        
        startBtn.addEventListener('click', () => {
            discovery.start();
        });
        
        stopBtn.addEventListener('click', () => {
            discovery.stop();
        });
        
        terminateBtn.addEventListener('click', () => {
            discovery.terminate();
        });
        
        // Make discovery available globally for debugging
        window.discovery = discovery;
        
        log('Kaspa Discovery Worker v27 - Connect Debug with detailed logging', 'info');
        log('Limited to 3 nodes for debugging', 'warning');
        log('Click Initialize to begin', 'info');
    </script>
</body>
</html>